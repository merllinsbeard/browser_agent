{
  "project": "Browser Agent",
  "branchName": "ralph/autonomous-browser-ai-agent",
  "description": "Autonomous AI agent that controls a visible web browser to perform arbitrary multi-step tasks based on natural language input. Uses hierarchical sub-agent architecture (Planner + Navigator + Safety) with element registry pattern and OpenAI Agents SDK.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Project setup and directory structure",
      "description": "As a developer, I need the project structure and dependencies set up.",
      "acceptanceCriteria": [
        "Create src/browser_agent directory with subdirectories: agents/, tools/, core/, models/, security/",
        "Create scripts/ directory for run.py and eval.py",
        "Create tests/ directory",
        "Initialize pyproject.toml with uv and dependencies: playwright, openai-agents, pydantic, rich, pytest",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Completed: All directories created, pyproject.toml with dependencies, typecheck passes"
    },
    {
      "id": "US-002",
      "title": "Persistent browser context setup",
      "description": "As a user, I want the agent to preserve my login session.",
      "acceptanceCriteria": [
        "Create src/browser_agent/core/browser.py with launch_persistent_context()",
        "Browser launches with user_data_dir for session persistence",
        "Browser launches in headful mode (visible window)",
        "Session directory configurable via CLI argument",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Completed: launch_persistent_context() with user_data_dir, headful mode default, CLI args for --session-dir and --headless"
    },
    {
      "id": "US-003",
      "title": "Pydantic models for Action, PageSnapshot, ActionResult",
      "description": "As a developer, I need type-safe data structures for the agent.",
      "acceptanceCriteria": [
        "Create src/browser_agent/models/action.py with Action enum (CLICK, TYPE, PRESS, SCROLL, NAVIGATE, WAIT, EXTRACT, DONE)",
        "Create src/browser_agent/models/snapshot.py with PageSnapshot: url, title, interactive_elements, visible_text_excerpt, screenshot_path, notes, version",
        "Create src/browser_agent/models/result.py with ActionResult: success, message, new_snapshot",
        "Create src/browser_agent/models/element.py with InteractiveElement: ref, role, name, aria_label, placeholder, value_preview, bbox",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Completed: Action enum, InteractiveElement, PageSnapshot, ActionResult models created with frozen dataclasses"
    },
    {
      "id": "US-004",
      "title": "Element Registry class for ID-based actions",
      "description": "As the agent, I want to reference elements by ID rather than selectors.",
      "acceptanceCriteria": [
        "Create src/browser_agent/core/registry.py with ElementRegistry class",
        "ElementRegistry assigns unique ref IDs during observation",
        "Each snapshot has version number for element validation",
        "Registry maps ref ID to Playwright locator dynamically",
        "Stale element references detected and rejected with clear error",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Completed: ElementRegistry with ref ID assignment, version tracking, dynamic locator mapping, stale detection"
    },
    {
      "id": "US-005",
      "title": "CLICK action tool",
      "description": "As the agent, I need to click elements by ref ID.",
      "acceptanceCriteria": [
        "Create src/browser_agent/tools/actions/click.py",
        "Function accepts element_id (ref ID) and executes click via Playwright",
        "Returns ActionResult with success status and message",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Completed: click() function in tools/actions/click.py with element ID resolution and error handling"
    },
    {
      "id": "US-006",
      "title": "TYPE action tool",
      "description": "As the agent, I need to type text into input elements.",
      "acceptanceCriteria": [
        "Create src/browser_agent/tools/actions/type.py",
        "Function accepts element_id and text, fills input via Playwright",
        "Returns ActionResult with success status and message",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Completed: type_() function for typing text into input elements by ref ID"
    },
    {
      "id": "US-007",
      "title": "PRESS action tool",
      "description": "As the agent, I need to press keyboard keys.",
      "acceptanceCriteria": [
        "Create src/browser_agent/tools/actions/press.py",
        "Function accepts key name (Enter, Escape, etc.) via Playwright",
        "Returns ActionResult with success status and message",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Completed: press() function for keyboard key presses"
    },
    {
      "id": "US-008",
      "title": "SCROLL action tool",
      "description": "As the agent, I need to scroll the page.",
      "acceptanceCriteria": [
        "Create src/browser_agent/tools/actions/scroll.py",
        "Function accepts dx, dy parameters and scrolls via Playwright",
        "Returns ActionResult with success status and message",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Completed: scroll() function for page scrolling with dx, dy"
    },
    {
      "id": "US-009",
      "title": "NAVIGATE action tool",
      "description": "As the agent, I need to navigate to URLs.",
      "acceptanceCriteria": [
        "Create src/browser_agent/tools/actions/navigate.py",
        "Function accepts URL and navigates via Playwright",
        "Returns ActionResult with success status and message",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Completed: navigate() function for URL navigation with HTTP status reporting"
    },
    {
      "id": "US-010",
      "title": "WAIT action tool",
      "description": "As the agent, I need to wait for conditions or timeouts.",
      "acceptanceCriteria": [
        "Create src/browser_agent/tools/actions/wait.py",
        "Function accepts timeout or condition and waits via Playwright",
        "Returns ActionResult with success status and message",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Completed: wait() function for waiting specified timeout"
    },
    {
      "id": "US-011",
      "title": "EXTRACT action tool",
      "description": "As the agent, I need to extract data from the page.",
      "acceptanceCriteria": [
        "Create src/browser_agent/tools/actions/extract.py",
        "Function accepts target description and extracts data via Playwright",
        "Returns ActionResult with extracted data",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Completed: extract() function for data extraction from page"
    },
    {
      "id": "US-012",
      "title": "DONE action tool",
      "description": "As the agent, I need to signal task completion.",
      "acceptanceCriteria": [
        "Create src/browser_agent/tools/actions/done.py",
        "Function accepts summary and signals completion",
        "Returns ActionResult with final summary",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Completed: done() function for signaling task completion"
    },
    {
      "id": "US-013",
      "title": "Page observation tool (browser_observe)",
      "description": "As the agent, I need to observe page state without full DOM dumps.",
      "acceptanceCriteria": [
        "Create src/browser_agent/tools/observe.py with browser_observe() function",
        "Uses Playwright aria_snapshot() for compact, semantic page representation",
        "Returns PageSnapshot with url, title, interactive_elements (40-80 max)",
        "Each element has ref ID, role, name, aria_label, placeholder, value_preview",
        "Visible text excerpt truncated to 2-4K characters",
        "No full HTML/DOM included",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Completed: browser_observe() uses aria_snapshot() with element extraction and text truncation"
    },
    {
      "id": "US-014",
      "title": "Screenshot capture tool",
      "description": "As the agent, I need to capture screenshots for fallback analysis.",
      "acceptanceCriteria": [
        "Create src/browser_agent/tools/screenshot.py with capture_screenshot() function",
        "Captures screenshot via Playwright and saves to disk",
        "Returns file path",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Completed: capture_screenshot() with auto-naming and full_page support"
    },
    {
      "id": "US-015",
      "title": "OpenRouter LLM integration",
      "description": "As the system, I want to use OpenRouter API for LLM calls.",
      "acceptanceCriteria": [
        "Create src/browser_agent/core/llm.py with OpenRouter client setup",
        "API key configured via OPENROUTER_API_KEY environment variable",
        "Default model: GPT-4o or equivalent via OpenRouter",
        "Proper error handling and retry logic included",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": "Completed: OpenRouter client with DEFAULT_MODEL, get_openrouter_client(), call_llm() function"
    },
    {
      "id": "US-016",
      "title": "Planner sub-agent",
      "description": "As the system, I want a Planner agent to break tasks into steps.",
      "acceptanceCriteria": [
        "Create src/browser_agent/agents/planner.py with Planner agent class",
        "Uses OpenAI Agents SDK Agent with handoff to Navigator",
        "Receives user task and creates step-by-step execution plan",
        "Plan stored in task memory for reference",
        "Maintains URL history for backtracking",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": true,
      "notes": "Completed: PlannerAgent with create_plan() using LLM, URL history tracking"
    },
    {
      "id": "US-017",
      "title": "Navigator sub-agent",
      "description": "As the system, I want a Navigator agent to execute browser actions.",
      "acceptanceCriteria": [
        "Create src/browser_agent/agents/navigator.py with Navigator agent class",
        "Uses OpenAI Agents SDK Agent with browser_observe and browser_act tools",
        "Receives plan steps and executes sequentially",
        "Calls browser_observe() before each action",
        "Returns to Planner on completion or failure",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Completed: NavigatorAgent with execute_step() parsing steps and calling action tools"
    },
    {
      "id": "US-018",
      "Title": "Safety sub-agent with confirmations",
      "description": "As a user, I want the agent to ask confirmation before destructive actions.",
      "acceptanceCriteria": [
        "Create src/browser_agent/agents/safety.py with Safety agent class",
        "Intercepts actions matching destructive patterns (delete, submit, payment)",
        "Destructive actions trigger user.confirm() with clear action summary",
        "Waits for yes/no response before proceeding",
        "Security enforced at CODE level via keyword matching, not LLM level",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Completed: SafetyAgent with code-level destructive pattern detection and rich console confirmations"
    },
    {
      "id": "US-019",
      "title": "Error recovery: re-observation and overlay detection",
      "description": "As the agent, I want to recover from failures by re-observing the page.",
      "acceptanceCriteria": [
        "Create src/browser_agent/core/recovery.py with detect_and_handle_overlays()",
        "Failed actions trigger re-observation via browser_observe()",
        "Detects popups/overlays via role='dialog' and aria-modal attributes",
        "Attempts dismissal of detected overlays",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-020",
      "title": "Error recovery: retry logic with backoff",
      "description": "As the agent, I want to retry failed actions with different approaches.",
      "acceptanceCriteria": [
        "Add retry_with_backoff() to src/browser_agent/core/recovery.py",
        "Waits for network/selector with exponential backoff (max 3 attempts)",
        "Never retries the exact same action twice",
        "After 3 consecutive failures, asks user for guidance",
        "Typecheck passes"
      ],
      "priority": 20,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-021",
      "title": "Error recovery: stuck detection",
      "description": "As the agent, I want to detect when I'm stuck and take action.",
      "acceptanceCriteria": [
        "Add detect_stuck() to src/browser_agent/core/recovery.py",
        "Stuck detection triggers after 5 actions with no progress",
        "When stuck, asks user if login/2FA needed or should try alternative approach",
        "Typecheck passes"
      ],
      "priority": 21,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-022",
      "title": "Context budget: single-snapshot retention",
      "description": "As the system, I want to limit context to prevent token bloat.",
      "acceptanceCriteria": [
        "Create src/browser_agent/core/context.py with ContextTracker class",
        "Implements single-snapshot retention (only most recent in context)",
        "Old snapshots discarded from context after new observation",
        "Typecheck passes"
      ],
      "priority": 22,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-023",
      "title": "Context budget: task memory compression",
      "description": "As the system, I want to compress task history to save tokens.",
      "acceptanceCriteria": [
        "Add compress_task_memory() to src/browser_agent/core/context.py",
        "Task memory compressed after each 10 steps (summarize older steps)",
        "Summary format: completed steps + current state",
        "Typecheck passes"
      ],
      "priority": 23,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Context budget: token usage tracking",
      "description": "As the system, I want to monitor token usage.",
      "acceptanceCriteria": [
        "Add track_tokens() to src/browser_agent/core/context.py",
        "Monitors token usage per category (snapshot, history, tools)",
        "Alerts when approaching token limit",
        "Target: <30 LLM calls per task",
        "Typecheck passes"
      ],
      "priority": 24,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-025",
      "title": "Hybrid observation: screenshot fallback",
      "description": "As the agent, I want screenshots as fallback when accessibility tree is insufficient.",
      "acceptanceCriteria": [
        "Create src/browser_agent/tools/hybrid_observe.py",
        "Screenshot captured on each observe() via capture_screenshot()",
        "Screenshot path included in PageSnapshot for analysis",
        "Typecheck passes"
      ],
      "priority": 25,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-026",
      "title": "Hybrid observation: vision model integration",
      "description": "As the agent, I want to use vision when accessibility tree has limited elements.",
      "acceptanceCriteria": [
        "Add invoke_vision_model() to src/browser_agent/tools/hybrid_observe.py",
        "Vision model invoked when ARIA snapshot has <10 interactive elements",
        "Uses GPT-4o Vision via OpenRouter API",
        "Returns element descriptions from screenshot",
        "Typecheck passes"
      ],
      "priority": 26,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-027",
      "title": "CLI interface: basic run script",
      "description": "As a user, I want a CLI script to launch the agent.",
      "acceptanceCriteria": [
        "Create scripts/run.py",
        "Launches agent with visible browser",
        "Accepts task input via command line argument or interactive prompt",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 27,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-028",
      "title": "CLI interface: progress display and confirmations",
      "description": "As a user, I want to see real-time progress and confirm actions.",
      "acceptanceCriteria": [
        "Add progress display to scripts/run.py using rich library",
        "Shows current step, action being taken",
        "Handles confirmation prompts for destructive actions",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 28,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-029",
      "title": "CLI interface: completion report",
      "description": "As a user, I want a summary report when the task is done.",
      "acceptanceCriteria": [
        "Add completion report to scripts/run.py",
        "Displays actions taken and outcomes (success/failure/next steps)",
        "Uses rich for formatted output",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 29,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-030",
      "title": "Evaluation script",
      "description": "As a developer, I want a script to evaluate agent performance.",
      "acceptanceCriteria": [
        "Create scripts/eval.py",
        "Runs predefined test tasks",
        "Measures success rate, step count, user input count, stuck situations",
        "Outputs report with metrics",
        "Can run against multiple test scenarios",
        "Typecheck passes"
      ],
      "priority": 30,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-031",
      "title": "Unit tests: browser tools",
      "description": "As a developer, I want tests for browser tools.",
      "acceptanceCriteria": [
        "Create tests/tools/test_observe.py for browser_observe()",
        "Create tests/tools/test_actions.py for all action tools",
        "Create tests/tools/test_screenshot.py for capture_screenshot()",
        "Tests use mocked Playwright page objects",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 31,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-032",
      "title": "Unit tests: ElementRegistry and ContextTracker",
      "description": "As a developer, I want tests for core classes.",
      "acceptanceCriteria": [
        "Create tests/core/test_registry.py for ElementRegistry",
        "Tests ID assignment, versioning, stale detection",
        "Create tests/core/test_context.py for ContextTracker",
        "Tests budget management, compression, token tracking",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 32,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-033",
      "title": "Integration tests: agent handoffs and error recovery",
      "description": "As a developer, I want tests for agent orchestration.",
      "acceptanceCriteria": [
        "Create tests/integration/test_agents.py",
        "Tests Planner -> Navigator handoff",
        "Tests Navigator action execution and return to Planner",
        "Tests error recovery flows (re-observation, retry, stuck detection)",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 33,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-034",
      "title": "Integration tests: safety logic",
      "description": "As a developer, I want tests for safety confirmations.",
      "acceptanceCriteria": [
        "Create tests/integration/test_safety.py",
        "Tests destructive pattern detection (delete, submit, payment)",
        "Tests confirmation prompt triggering",
        "Tests code-level enforcement (not LLM bypass)",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 34,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-035",
      "title": "Test coverage verification",
      "description": "As a developer, I want to ensure 80%+ test coverage.",
      "acceptanceCriteria": [
        "Run pytest with coverage reporting",
        "Coverage report shows >=80%",
        "Any gaps identified and addressed",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 35,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-036",
      "title": "Demo preparation",
      "description": "As a project stakeholder, I want a working demo of all features.",
      "acceptanceCriteria": [
        "Launch sequence shows browser opening and agent starting",
        "Demo includes normal step (search/navigation/form)",
        "Demo includes failure recovery (popup/error handling)",
        "Demo includes dangerous action with user confirmation",
        "Demo ends with completion report",
        "Demo uses novel task (not pre-scripted)",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 36,
      "passes": false,
      "notes": ""
    }
  ]
}
