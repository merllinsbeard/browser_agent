## Codebase Patterns
- Use `uv run` for all Python commands (e.g., `uv run mypy src/`, `uv run pytest`)
- Project uses strict mypy settings (disallow_untyped_defs = true) - all functions must be typed
- pyproject.toml uses hatchling as build backend
- Use dependency-groups for dev dependencies (uv >=0.5.0)
- src/ layout: src/browser_agent/ contains all package code
- Playwright's `launch_persistent_context()` returns BrowserContext, not Browser - browser closes when context closes
- Use `str(path)` when passing pathlib.Path to Playwright APIs (they expect str, not Path)
- Use frozen dataclasses for immutable models (Action, PageSnapshot, ActionResult, InteractiveElement)
- Action inherits from both str and Enum for JSON serialization compatibility
- Element registry uses snapshot versioning to prevent stale element references
- Element refs follow pattern "elem-{index}" for predictable identification
- Some Playwright methods don't accept timeout (e.g., keyboard.press()) - check API docs
- For string parameters with fixed options, use Literal type for type safety (e.g., navigate.wait_until)

# Ralph Progress Log
Started: Mon Jan 26 22:00:52 MSK 2026
---

## Jan 26, 2026 - US-001
- Created src/browser_agent directory with subdirectories: agents/, tools/, core/, models/, security/
- Created scripts/run.py and scripts/eval.py entry points
- Created tests/ directory
- Created pyproject.toml with uv, dependencies: playwright, openai-agents, pydantic, rich, pytest
- Set up basic CLI entry point at src/browser_agent/cli.py
- Typecheck passes with mypy

**Learnings for future iterations:**
- The pyproject.toml [project] section should NOT include `readme = "README.md"` if README.md doesn't exist - this causes build failures
- Use [dependency-groups] instead of deprecated [tool.uv.dev-dependencies] for uv >=0.5.0
- Run `uv run mypy src/` to verify type checking - it will auto-install dependencies and build the package

---

## Jan 26, 2026 - US-002
- Created src/browser_agent/core/browser.py with launch_persistent_context()
  - Takes Playwright instance and user_data_dir for session persistence
  - headless parameter defaults to False for visible (headful) browser
  - Returns BrowserContext (not Browser) - browser auto-closes when context closes
  - Includes detailed docstring with usage example and warnings
- Updated src/browser_agent/cli.py with argparse configuration:
  - --session-dir argument with default to ~/.browser-agent/session
  - --headless flag to optionally run in headless mode
  - Added test browser launch with Ctrl+C handling for graceful shutdown
- Typecheck passes (mypy strict mode)

**Learnings for future iterations:**
- Playwright's `launch_persistent_context()` returns BrowserContext directly, not (Browser, Context) tuple
- The browser is automatically closed when the context is closed - no need to track browser separately
- Chrome policies prevent automating the main user profile - always use a dedicated directory
- Use `str(path)` when passing pathlib.Path to Playwright APIs

---

## Jan 26, 2026 - US-003
- Created src/browser_agent/models/action.py:
  - Action enum (str, Enum) with CLICK, TYPE, PRESS, SCROLL, NAVIGATE, WAIT, EXTRACT, DONE
- Created src/browser_agent/models/element.py:
  - BoundingBox dataclass (x, y, width, height)
  - InteractiveElement dataclass with ref, role, name, aria_label, placeholder, value_preview, bbox
- Created src/browser_agent/models/snapshot.py:
  - PageSnapshot dataclass with url, title, interactive_elements, visible_text_excerpt, screenshot_path, notes, version
  - with_version() helper for incrementing snapshot version
- Created src/browser_agent/models/result.py:
  - ActionResult dataclass with success, message, new_snapshot, error
  - Static helpers: success_result() and failure_result()
- Typecheck passes (mypy strict mode)

**Learnings for future iterations:**
- Use frozen dataclasses for immutable models (prevents accidental modification)
- Action inherits from both str and Enum for JSON serialization and string comparison
- field(default_factory=list) for mutable default arguments in dataclasses

---

## Jan 26, 2026 - US-004
- Created src/browser_agent/core/registry.py:
  - StaleElementError: Custom exception with helpful error message
  - RegistryEntry: Stores element, snapshot_version, selector
  - ObservationResult: Result of page observation with elements and version
  - ElementRegistry class:
    - Assigns unique ref IDs (elem-0, elem-1, etc.)
    - Tracks snapshot version for validation
    - register_elements(): Register batch of elements with selectors
    - get_locator(): Returns Playwright Locator for element ref
    - get_element(): Returns InteractiveElement for element ref
    - increment_version(): Clears stale entries, increments version
    - clear(): Reset registry to initial state
- Stale element detection: Raises StaleElementError when using old element ref
- Dynamic selector mapping: Ref IDs map to Playwright locators at runtime
- Typecheck passes (mypy strict mode)

**Learnings for future iterations:**
- Element registry uses snapshot versioning to prevent acting on stale elements
- Element refs follow pattern "elem-{index}" for predictable identification
- Custom exceptions with detailed context help debugging (StaleElementError)

---

## Jan 26, 2026 - US-005
- Created src/browser_agent/tools/actions/ directory structure
- Created src/browser_agent/tools/actions/__init__.py
- Created src/browser_agent/tools/actions/click.py:
  - click() function with typed arguments (page: Page, registry, element_id, timeout)
  - Resolves element ID to Playwright Locator via ElementRegistry.get_locator()
  - Returns ActionResult.success_result() on successful click
  - Handles StaleElementError, PlaywrightTimeoutError, and generic exceptions
  - Configurable timeout (default 30000ms)
- Typecheck passes (mypy strict mode)

**Learnings for future iterations:**
- Action tools should follow pattern: resolve element via registry, perform action, return ActionResult
- Use PlaywrightTimeoutError alias to avoid confusion with built-in TimeoutError
- Action tools should handle all exceptions and return failure_result with error details

---

## Jan 26, 2026 - US-006 through US-012
Batch created all remaining action tools following established pattern:

- src/browser_agent/tools/actions/type.py (US-006):
  - type_() function for typing text into input elements by ref ID
  - Uses locator.fill() for text entry
  - Handles StaleElementError and PlaywrightTimeoutError

- src/browser_agent/tools/actions/press.py (US-007):
  - press() function for keyboard key presses
  - Supports standard keys and combinations (e.g., Control+A)
  - Note: page.keyboard.press() doesn't accept timeout parameter

- src/browser_agent/tools/actions/scroll.py (US-008):
  - scroll() function for page scrolling with dx, dy parameters
  - Uses JavaScript window.scrollBy() for scrolling
  - Reports scroll direction and distance in result message

- src/browser_agent/tools/actions/navigate.py (US-009):
  - navigate() function for URL navigation
  - wait_until parameter with Literal type ("load", "domcontentloaded", "networkidle", "commit")
  - Returns HTTP status in success message

- src/browser_agent/tools/actions/wait.py (US-010):
  - wait() function for waiting a specified timeout (ms)
  - Uses page.wait_for_timeout()

- src/browser_agent/tools/actions/extract.py (US-011):
  - extract() function for data extraction from page
  - Handles common targets: title, url, text, links, inputs
  - Generic fallback returns page content (first 2000 chars)

- src/browser_agent/tools/actions/done.py (US-012):
  - done() function for signaling task completion
  - Returns ActionResult with completion summary

- Updated __init__.py to export all action tools

Typecheck passes (mypy strict mode).

**Learnings for future iterations:**
- Some Playwright methods don't accept timeout (e.g., keyboard.press()) - check API docs
- For string parameters with fixed options, use Literal type for type safety
- Function name with trailing underscore (type_) to avoid shadowing built-in type

---
